{% if ansible_fqdn in groups['logstash-shipper'] %}
input {
    beats {
        port => "5044"
    }
}

output {
    rabbitmq {
         host => "{{ rabbitmq_hostname }}"
         exchange => "t1-raw-log"
         exchange_type => "direct"
         user => "{{ rabbitmq_username }}"
         password => "{{ rabbitmq_password }}"
         vhost => "{{ rabbitmq_vhost }}"
         workers => 1
         durable => true
         persistent => true
    }
}
{% elif ansible_fqdn in groups['logstash-raw-log'] %}
input {
  rabbitmq {
    host => "{{ rabbitmq_hostname }}"
    exchange => "t1-raw-log"
    user => "{{ rabbitmq_username }}"
    password => "{{ rabbitmq_password }}"
    vhost => "{{ rabbitmq_vhost }}"
    queue => "t1-raw-log"
    tags  => [ "t1-raw-log" ]
    durable => true
    ack => true
    threads => 1
    prefetch_count => 50
    port => 5672
  }
}

output {
  rabbitmq {
       host => "{{ rabbitmq_hostname }}"
       exchange => "t2-grok-ready"
       exchange_type => "direct"
       user => "{{ rabbitmq_username }}"
       password => "{{ rabbitmq_password }}"
       vhost => "{{ rabbitmq_vhost }}"
       workers => 1
       durable => true
       persistent => true
  }
}
{% elif ansible_fqdn in groups['logstash-grok-ready'] %}
input {
  rabbitmq {
    host => "{{ rabbitmq_hostname }}"
    exchange => "t2-grok-ready"
    user => "{{ rabbitmq_username }}"
    password => "{{ rabbitmq_password }}"
    vhost => "{{ rabbitmq_vhost }}"
    queue => "t2-grok-ready"
    tags  => [ "t2-grok-ready" ]
    durable => true
    ack => true
    threads => 1
    prefetch_count => 50
    port => 5672
  }
}

filter {
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:time}"}
  }
}

output {
  rabbitmq {
       host => "{{ rabbitmq_hostname }}"
       exchange => "t3-grok-complete"
       exchange_type => "direct"
       user => "{{ rabbitmq_username }}"
       password => "{{ rabbitmq_password }}"
       vhost => "{{ rabbitmq_vhost }}"
       workers => 1
       durable => true
       persistent => true
  }
}
{% elif ansible_fqdn in groups['logstash-grok-complete'] %}
input {
  rabbitmq {
    host => "{{ rabbitmq_hostname }}"
    exchange => "t3-grok-complete"
    user => "{{ rabbitmq_username }}"
    password => "{{ rabbitmq_password }}"
    vhost => "{{ rabbitmq_vhost }}"
    queue => "t3-grok-complete"
    tags  => [ "t3-grok-complete" ]
    durable => true
    ack => true
    threads => 1
    prefetch_count => 50
    port => 5672
  }
}

output {
  elasticsearch {
    hosts => "http://elasticsearch.wdaws.com"
    index => "work-%{+YYYY.MM.dd}"
  }
}
{% endif %}